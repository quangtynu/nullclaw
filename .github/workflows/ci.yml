name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x86_64
          - os: macos-latest
            target: macos-aarch64
          - os: windows-latest
            target: windows-x86_64

    steps:
      - uses: actions/checkout@v4

      - name: Install Zig 0.15.2
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Cache .zig-cache
        uses: actions/cache@v4
        with:
          path: .zig-cache
          key: zig-${{ matrix.target }}-${{ hashFiles('src/**/*.zig', 'build.zig') }}
          restore-keys: zig-${{ matrix.target }}-

      - name: Run tests
        run: zig build test --summary all 2>&1 | tee test-output.txt

      - name: Build ReleaseSmall
        run: zig build -Doptimize=ReleaseSmall

      - name: Cross-compile linux-aarch64 (Termux/ARM)
        if: runner.os == 'Linux'
        run: zig build -Dtarget=aarch64-linux-musl -Doptimize=ReleaseSmall

      - name: Job summary
        if: always()
        run: |
          echo "## nullClaw CI — ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output.txt ]; then
            TESTS=$(grep -o '[0-9]*/[0-9]* tests passed' test-output.txt | head -1 || true)
            RSS=$(grep 'run test' test-output.txt | grep -o 'MaxRSS:[^ ]*' | head -1 | cut -d: -f2 || true)
            echo "| Tests | ${TESTS:-—} |" >> $GITHUB_STEP_SUMMARY
            echo "| Test MaxRSS | ${RSS:-—} |" >> $GITHUB_STEP_SUMMARY
          fi

          BIN="zig-out/bin/nullclaw"
          if [ "${{ runner.os }}" = "Windows" ]; then
            BIN="zig-out/bin/nullclaw.exe"
          fi
          if [ -f "$BIN" ]; then
            SIZE=$(wc -c < "$BIN" | tr -d ' ')
            SIZE_HR=$(awk "BEGIN {printf \"%.1f MB\", $SIZE / 1048576}")
            echo "| Binary (ReleaseSmall) | ${SIZE_HR} (${SIZE} bytes) |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload binary
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: nullclaw-${{ matrix.target }}
          path: zig-out/bin/nullclaw${{ runner.os == 'Windows' && '.exe' || '' }}
